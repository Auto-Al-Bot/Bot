<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>ðŸ’± Auto-Trading Bot</title>

    <!-- Favicon/Logo (Using the ðŸ’± emoji as requested) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’±</text></svg>">

    <!-- PWA Manifest Link (Generated via JS) -->
    <link rel="manifest" id="pwa-manifest-link">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- External Libraries (as requested) -->
    <script src="https://s3.tradingview.com/tv.js"></script> <!-- TradingView Widget API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script> <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.min.js"></script> <!-- OTP Library (for Auth) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> <!-- Crypto JS -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script> <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script> <!-- WalletConnect -->
    <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script> <!-- Web3Modal -->

    <style>
        /*
        =======================================================
        GLOBAL STYLING (Binance Dark Mode: Black & Yellow)
        =======================================================
        */
        :root {
            --bg-dark: #121417; /* Deeper Background */
            --bg-card: #1c1f24; /* Card/Panel Background */
            --text-primary: #f0f0f0;
            --text-muted: #848e9c;
            --accent-yellow: #f0b90b; /* Primary Accent */
            --accent-green: #16c784;
            --accent-red: #ea3943;
            --border: #363a45;
            --header-height: 56px;
        }

        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Tailwind Configuration Override */
        .page {
            display: none;
            min-height: calc(100vh - var(--header-height));
            padding-bottom: 70px; /* Space for fixed footer */
            max-width: 480px;
            margin: 0 auto;
        }

        .header-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .nav-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 480px;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border);
            z-index: 100;
        }

        /* Custom Buttons */
        .btn-yellow {
            background-color: var(--accent-yellow);
            color: #111827;
            font-weight: 600;
            transition: background-color 0.15s;
        }

        .btn-yellow:hover {
            background-color: #e6b007;
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            margin: auto;
            max-width: 400px;
            z-index: 1000;
            background-color: var(--bg-card);
            border-bottom: 4px solid var(--accent-yellow);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            padding: 1rem;
            border-radius: 0 0 10px 10px;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="text-white">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-lg font-semibold">Loading...</p>
    </div>

    <!-- Global Toast Notification -->
    <div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[3000]"></div>

    <!-- Global Dropdown Menus -->
    <div id="more-menu" class="absolute right-4 top-14 w-56 bg-gray-800 rounded-lg shadow-xl py-2 z-50 hidden transition-opacity duration-150 border border-gray-700">
        <!-- Content inserted by JS -->
    </div>

    <div id="landing-more-menu" class="absolute right-4 top-14 w-56 bg-gray-800 rounded-lg shadow-xl py-2 z-50 hidden transition-opacity duration-150 border border-gray-700">
        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('walletConnectorPage'); closeLandingMoreMenu();">Connect Portfolio</button>
        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('loginIDPage'); closeLandingMoreMenu();">Login ID</button>
        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('supportPage'); closeLandingMoreMenu();">Support</button>
        <div class="h-px bg-gray-700 my-1"></div>
        <button class="w-full text-left px-4 py-2 text-yellow-400 font-semibold hover:bg-gray-700" onclick="showPage('walletConnectorPage'); closeLandingMoreMenu();">Start Free Trial</button>
    </div>

    <!-- Global App Container (Max 480px width for mobile focus) -->
    <div class="mx-auto max-w-lg">
        <!-- =======================================================
        1. LANDING PAGE (CoinStats Style)
        ======================================================= -->
        <div id="landingPage" class="page p-4 pt-10">
            <!-- Landing Header -->
            <header class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-2">
                    <span class="text-4xl">ðŸ’±</span>
                    <span class="text-2xl font-bold">Auto-Trading Bot</span>
                </div>
                <div class="flex items-center gap-3">
                    <button class="text-xs px-3 py-1 bg-gray-800 rounded-full font-semibold hover:bg-gray-700" onclick="showPage('loginIDPage')">Login ID</button>
                    <button class="p-2 rounded-full hover:bg-gray-800" onclick="toggleLandingMoreMenu()" id="landingMoreBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                </div>
            </header>

            <!-- Hero Section (CoinStats Style) -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold leading-tight mb-4">
                    Unlock <span class="text-yellow-400">Automated</span> Crypto Returns
                </h1>
                <p class="text-gray-400 mb-6 max-w-md mx-auto">
                    The next generation **blockchain auto-trading system bot** for high-frequency trading and portfolio management. Secure, efficient, and fully automated.
                </p>
                <div class="flex justify-center gap-4">
                    <button class="btn-yellow px-6 py-3 rounded-full text-md" onclick="showPage('walletConnectorPage')">
                        Connect Portfolio
                    </button>
                    <button class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-full text-md font-semibold" onclick="showPage('walletConnectorPage')">
                        Start Free Trial
                    </button>
                </div>
                <button id="installAppPromptBtn" class="mt-6 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm text-yellow-400 hidden" onclick="handleInstallAppDisplay()">
                    Get Mobile App
                </button>
            </div>
            
            <!-- Install PWA Prompt UI (As Requested) -->
            <div id="installPromptContainer"></div>

            <!-- Market Overview / Live Prices -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-bold mb-4">Market Overview</h2>
                <div id="topCoinsList" class="space-y-3">
                    <p class="text-gray-400 text-center">Loading live prices...</p>
                </div>
            </div>
        </div>

        <!-- =======================================================
        2. LOGIN ID PAGE
        ======================================================= -->
        <div id="loginIDPage" class="page p-6 pt-10">
            <h2 class="text-3xl font-bold mb-8 text-center">Log In with Account ID</h2>
            <div class="bg-gray-800 p-6 rounded-xl space-y-4">
                <label for="accountIdInput" class="block text-sm font-medium text-gray-300">Enter Account ID (10 Digits)</label>
                <input type="number" id="accountIdInput" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="e.g., 1234567890">
                <button id="loginIdConfirmBtn" class="w-full btn-yellow px-4 py-3 rounded-lg mt-4" onclick="loginWithID()">
                    Confirm Log In
                </button>
            </div>
            <p class="text-center text-gray-500 mt-6">Don't have an ID? <button class="text-yellow-400 hover:underline" onclick="showPage('walletConnectorPage')">Connect Wallet</button> to get one.</p>
        </div>

        <!-- =======================================================
        3. WALLET CONNECTOR PAGE
        ======================================================= -->
        <div id="walletConnectorPage" class="page p-6 pt-10">
            <h2 class="text-3xl font-bold mb-8 text-center">Connect Your Portfolio</h2>
            <div class="space-y-6">
                <!-- WalletConnect (Mobile & QR) -->
                <button id="web3ConnectBtn" class="w-full flex items-center justify-center gap-3 py-4 px-6 bg-gray-800 rounded-xl hover:bg-gray-700 transition border border-yellow-400/50" onclick="connectWallet()">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354l2.553 5.372 5.945.864-4.295 4.183 1.012 5.922L12 18.007l-5.216 2.744 1.012-5.922-4.295-4.183 5.945-.864L12 4.354z"></path></svg>
                    Connect Wallet (Mobile / QR)
                </button>

                <div class="text-center text-gray-500 my-4">--- OR ---</div>

                <!-- Manual Connection -->
                <div class="bg-gray-800 p-5 rounded-xl space-y-4">
                    <h3 class="text-xl font-semibold">Manual Address Connection</h3>
                    <input type="text" id="manualAddressInput" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Enter wallet address / mainnet ID">
                    <button id="manualConnectBtn" class="w-full btn-yellow px-4 py-3 rounded-lg" onclick="manualConnect()">
                        Connect Address
                    </button>
                    <div id="manualStatus" class="text-sm mt-3 text-gray-400"></div>
                </div>
            </div>
            
            <!-- Connection Confirmation Modal -->
            <div id="confirmConnectionModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1500]">
                <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm text-center">
                    <h3 class="text-2xl font-bold mb-4">Connection Confirmed</h3>
                    <p class="text-gray-400 mb-6">Your wallet connection has been secured. You will now be redirected to the Home page.</p>
                    <button class="btn-yellow px-6 py-2 rounded-lg" onclick="handleConfirmedConnection()">
                        Continue to Home
                    </button>
                </div>
            </div>
        </div>

        <!-- =======================================================
        4. HOME PAGE (Binance Style)
        ======================================================= -->
        <div id="home" class="page">
            <!-- Header (Binance Style: Search, Notification, Support) -->
            <div class="header-bar px-4">
                <div class="text-xl font-bold text-yellow-400">ðŸ’± BOT</div>
                <div class="flex items-center space-x-4">
                    <button class="p-2 hover:bg-gray-700 rounded-full" onclick="showPage('searchPage')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                    <button class="p-2 hover:bg-gray-700 rounded-full" onclick="showPage('notificationPage')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    </button>
                    <button id="moreBtn" class="p-2 hover:bg-gray-700 rounded-full" onclick="toggleMoreMenu()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                    </button>
                </div>
            </div>

            <div id="homeContent" class="p-4 space-y-6">
                <!-- User ID and Balance Card -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <span id="userIdDisplay" class="text-sm font-mono bg-gray-800 px-3 py-1 rounded-full text-yellow-400">ID: 1234567890</span>
                        <button class="text-xs text-gray-400 hover:text-yellow-400" onclick="showPage('walletPage')">
                            Connected Wallet
                        </button>
                    </div>
                    <p class="text-sm text-gray-400">Total Portfolio Balance</p>
                    <h2 id="totalBalanceUSD" class="text-3xl font-bold mt-1 mb-4">$0.00</h2>

                    <!-- Deposit/Withdraw/Earn Row -->
                    <div class="flex justify-between items-center mt-6">
                        <button class="flex flex-col items-center text-sm font-semibold text-gray-200 hover:text-yellow-400" onclick="showPage('depositCoinSelectPage')">
                            <svg class="w-7 h-7 mb-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Deposit
                        </button>
                        <button class="flex flex-col items-center text-sm font-semibold text-gray-200 hover:text-yellow-400" onclick="showPage('withdrawalPage')">
                            <svg class="w-7 h-7 mb-1 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0l-4 4m4-4v14"></path></svg>
                            Withdraw
                        </button>
                        <button class="flex flex-col items-center text-sm font-semibold text-gray-200 hover:text-yellow-400" onclick="showPage('tradePage')">
                            <svg class="w-7 h-7 mb-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                            Trade
                        </button>
                    </div>
                </div>
                
                <!-- Trade Suspension Banner -->
                <div id="suspensionBanner" class="bg-red-900 border border-red-700 p-3 rounded-xl text-sm text-red-100 hidden">
                    <p class="font-semibold">Withdrawal Suspended!</p>
                    <p class="text-xs mt-1" id="suspensionTime"></p>
                </div>

                <!-- TradingView Chart Section -->
                <div class="bg-gray-900 p-3 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">BTC/USDT Performance</h3>
                    <div id="tvchart" style="height: 300px;"></div>
                </div>

                <!-- Token Holdings Section -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-4">Token Holdings</h3>
                    <div id="tokenHoldingsList" class="space-y-3">
                        <p class="text-gray-400 text-sm">No tokens held. Deposit to get started.</p>
                    </div>
                </div>

                <!-- Market Updates Section -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-4">Top Market Movers</h3>
                    <div id="homeMarketList" class="space-y-3">
                        <p class="text-gray-400 text-center">Loading market data...</p>
                    </div>
                </div>

                <!-- Activities & Transactions -->
                <button class="w-full text-left text-lg font-semibold text-gray-300 hover:text-yellow-400 pt-2" onclick="showPage('activitiesPage')">
                    Transactions & Activities
                    <svg class="w-5 h-5 inline ml-1 align-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <div id="homeActivitiesList" class="bg-gray-900 p-4 rounded-xl space-y-3 text-sm border border-gray-800">
                    <p class="text-gray-500">No recent activities.</p>
                </div>

            </div>
        </div>

        <!-- =======================================================
        5. MARKET PAGE (Binance Style)
        ======================================================= -->
        <div id="marketPage" class="page">
            <div class="header-bar">
                <h1 class="text-xl font-bold">Markets</h1>
                <button class="p-2 hover:bg-gray-700 rounded-full" onclick="showPage('searchPage')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </button>
            </div>
            <div class="p-4">
                <div id="marketPageOverview" class="mb-4 text-sm text-gray-400">
                    <p>Total Cryptos: N/A | Markets: N/A | 24h Volume: N/A</p>
                </div>
                <div class="flex gap-4 mb-4">
                    <button class="text-sm font-semibold py-2 px-3 rounded-full bg-yellow-400/20 text-yellow-400" data-filter="gainers" onclick="loadMarketData('gainers')">Top Gainers</button>
                    <button class="text-sm font-semibold py-2 px-3 rounded-full bg-gray-700/50 text-gray-300" data-filter="losers" onclick="loadMarketData('losers')">Top Losers</button>
                </div>
                
                <div class="flex justify-between text-xs font-semibold text-gray-500 pb-2 border-b border-gray-700">
                    <span class="w-1/3">Name/Symbol</span>
                    <span class="w-1/3 text-right">Price (USD)</span>
                    <span class="w-1/3 text-right">24h %</span>
                </div>

                <div id="marketCoinList" class="divide-y divide-gray-800">
                    <p class="text-gray-400 text-center py-8">Loading market data...</p>
                </div>
            </div>
            
            <!-- Coin News (Simulated) -->
            <div class="p-4 pt-0">
                <h3 class="text-lg font-bold mb-3">Crypto News</h3>
                <div id="coinNews" class="bg-gray-900 p-4 rounded-xl space-y-3 text-sm border border-gray-800">
                    <p class="text-gray-500">No recent news available.</p>
                </div>
            </div>
        </div>

        <!-- =======================================================
        6. TRADE PAGE (Binance/TradingView Style)
        ======================================================= -->
        <div id="tradePage" class="page">
            <div class="header-bar justify-start gap-4">
                <button class="text-lg font-bold">Trade</button>
                <button class="text-sm font-semibold py-1 px-3 rounded-full bg-yellow-400/20 text-yellow-400" onclick="showPage('tradeSelectAssetPage')">
                    Asset: <span id="currentTradeAsset">BTCUSDT</span>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <!-- Trade Balance and Earnings -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <p class="text-sm text-gray-400">Total Trade Balance</p>
                    <h2 id="totalTradeBalanceUSD" class="text-3xl font-bold mt-1 mb-4">$0.00</h2>
                    
                    <div class="flex justify-between items-center text-sm mb-4">
                        <span class="text-gray-400">Total Generated Returns:</span>
                        <span id="totalTradeReturns" class="font-semibold text-accent-green">+$0.00</span>
                    </div>

                    <div class="flex gap-3">
                        <button class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-semibold" onclick="showPage('tradeTransferPage')">
                            Transfer
                        </button>
                        <button class="w-full btn-yellow px-4 py-2 rounded-lg text-sm font-semibold" onclick="handlePlaceTrade()">
                            Place Trade
                        </button>
                    </div>
                </div>

                <!-- Live Trading Chart (Dynamic Asset) -->
                <div class="bg-gray-900 p-3 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">Live Trading View</h3>
                    <div id="tradeLiveChart" style="height: 300px;"></div>
                </div>
                
                <!-- Trade Status / Countdown -->
                <div id="tradeStatusPanel" class="bg-gray-800 p-3 rounded-xl text-sm hidden">
                    <p class="font-semibold text-yellow-400">Trading Bot Active</p>
                    <p id="tradeCountdownDisplay" class="text-gray-400 mt-1"></p>
                </div>
            </div>
        </div>

        <!-- =======================================================
        7. DEPOSIT ASSET FLOW PAGES
        ======================================================= -->
        
        <!-- 7.1 Select Coin Page (A-Z) -->
        <div id="depositCoinSelectPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Select Deposit Coin</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 space-y-4">
                <input type="text" id="depositSearch" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Search coin name or symbol">
                <div id="depositCoinList" class="space-y-3">
                    <!-- Coins loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- 7.2 Select Network Page -->
        <div id="depositNetworkPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('depositCoinSelectPage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Select Network for <span id="depositCoinName" class="text-yellow-400"></span></h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 space-y-4" id="networkSelectionList">
                <!-- Networks loaded dynamically -->
            </div>
        </div>

        <!-- 7.3 Deposit Address/QR Page -->
        <div id="depositAddressPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('depositNetworkPage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold"><span id="depositNetworkHeader">Network</span> Deposit</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-6 text-center space-y-6">
                <div class="bg-white p-4 rounded-xl inline-block shadow-lg">
                    <div id="qrcode"></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 break-all">
                    <p class="text-sm text-gray-400 mb-2">Deposit Address (Send Only <span id="depositAddressCoin"></span>)</p>
                    <p id="depositAddressDisplay" class="font-mono text-sm text-yellow-400 break-all">Loading...</p>
                </div>
                <button class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg text-sm font-semibold flex items-center justify-center gap-2" onclick="copyDepositAddress()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 002-2h2a2 2 0 002 2"></path></svg>
                    Copy Address
                </button>
                <button class="w-full btn-yellow px-4 py-3 rounded-lg text-md font-semibold" onclick="showDepositConfirmationPage()">
                    I have completed the deposit
                </button>
            </div>
        </div>

        <!-- 7.4 Deposit Confirmation Page -->
        <div id="depositConfirmPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('depositAddressPage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Confirm Deposit</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-6 bg-gray-900 rounded-xl m-4 space-y-6">
                <div class="flex justify-between border-b border-gray-800 pb-3">
                    <span class="text-gray-400">Amount to Confirm:</span>
                    <span class="text-xl font-bold text-green-400">$<span id="depositConfirmAmount">0.00</span></span>
                </div>
                
                <input type="number" id="depositAmountInput" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Enter deposit amount (USD)">
                
                <label for="depositVerificationCode" class="block text-sm font-medium text-gray-300">Enter Verification Code (6-digit)</label>
                <input type="number" id="depositVerificationCode" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="e.g., 123456">
                <p id="depositCodeError" class="text-red-500 text-sm hidden">Error message</p>

                <button class="w-full btn-yellow px-4 py-3 rounded-lg font-semibold" onclick="handleDepositConfirmation()">
                    Verify & Process Deposit
                </button>
            </div>
        </div>

        <!-- =======================================================
        8. WITHDRAWAL FLOW PAGES
        ======================================================= -->
        
        <!-- 8.1 Withdrawal Selection -->
        <div id="withdrawalPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Withdraw Assets</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 pt-10 text-center space-y-6">
                <p class="text-gray-400 text-lg">Select Withdrawal Method</p>
                <button class="w-full py-4 px-6 bg-gray-800 rounded-xl hover:bg-gray-700 transition border border-gray-700" onclick="showPage('onChainWithdrawalPage')">
                    <span class="text-xl font-semibold">On-Chain Transfer</span>
                    <p class="text-sm text-gray-400 mt-1">Send to external wallet address.</p>
                </button>
                <button class="w-full py-4 px-6 bg-gray-800 rounded-xl hover:bg-gray-700 transition border border-gray-700" onclick="showPage('accountIDWithdrawalPage')">
                    <span class="text-xl font-semibold">User Account ID</span>
                    <p class="text-sm text-gray-400 mt-1">Send to another bot user's ID.</p>
                </button>
            </div>
        </div>

        <!-- 8.2 On-Chain Withdrawal Details -->
        <div id="onChainWithdrawalPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('withdrawalPage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">On-Chain Withdrawal</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 pt-6 bg-gray-900 m-4 rounded-xl space-y-4">
                <h3 class="font-semibold text-lg text-gray-200">Withdraw to External Address</h3>

                <!-- Address Input -->
                <div>
                    <label for="withdrawalAddress" class="block text-sm font-medium text-gray-400">Enter Withdrawal Address</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="withdrawalAddress" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Destination Address">
                        <button class="bg-gray-700 text-xs px-3 py-1 rounded-lg text-yellow-400" onclick="fillFromConnectedWallet()">Fill from Wallet</button>
                    </div>
                </div>

                <!-- Network Selection -->
                <div>
                    <label for="selectNetworkBtn" class="block text-sm font-medium text-gray-400">Select Network</label>
                    <button id="selectNetworkBtn" class="w-full flex justify-between items-center px-4 py-3 mt-1 rounded-lg bg-gray-800 border border-gray-700 text-left" onclick="toggleNetworkDropdown()">
                        <span id="selectedNetworkDisplay">BNB Smart Chain BEP20</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="networkDropdown" class="mt-1 bg-gray-800 rounded-lg shadow-xl py-2 hidden">
                        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="selectWithdrawalNetwork('Ethereum network')">Etc Ethereum network</button>
                        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="selectWithdrawalNetwork('Bitcoin network')">BTC Bitcoin network</button>
                        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="selectWithdrawalNetwork('BNB Smart Chain BEP20')">BNB Smart Chain BEP20 Network</button>
                        <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="selectWithdrawalNetwork('Tron TRC 20')">Tron TRC 20 network</button>
                    </div>
                </div>

                <!-- Amount Input -->
                <div>
                    <label for="withdrawalAmount" class="block text-sm font-medium text-gray-400">Enter Withdrawal Amount (USDT)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="number" id="withdrawalAmount" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Amount">
                        <button class="bg-gray-700 text-xs px-3 py-1 rounded-lg text-yellow-400" onclick="fillMaxWithdrawal()">Max</button>
                    </div>
                </div>

                <!-- Summary & Fee -->
                <div class="flex justify-between text-sm pt-2 border-t border-gray-800">
                    <span class="text-gray-400">Gas Fee:</span>
                    <span class="font-semibold text-yellow-400">0.034 BNB</span>
                </div>

                <!-- Withdraw Button -->
                <button class="w-full btn-yellow px-4 py-3 rounded-lg font-semibold" onclick="showWithdrawalConfirmation()">
                    Withdraw
                </button>
            </div>
        </div>

        <!-- 8.3 Withdrawal Confirmation Modal -->
        <div id="withdrawalConfirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1500]">
            <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm space-y-4">
                <h3 class="text-2xl font-bold mb-4 text-center">Confirm Withdrawal</h3>
                <label for="withdrawalValidationCode" class="block text-sm font-medium text-gray-300">Enter Validation Code (6-digit)</label>
                <input type="number" id="withdrawalValidationCode" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Validation Code">
                <p id="withdrawalCodeError" class="text-red-500 text-sm hidden">Error message</p>
                <button class="w-full btn-yellow px-6 py-2 rounded-lg" onclick="handleWithdrawal()">
                    Submit Code
                </button>
                <p class="text-xs text-gray-500 text-center mt-3">5 attempts remaining before suspension.</p>
            </div>
        </div>
        
        <!-- 8.4 Withdrawal Processing Page -->
        <div id="withdrawalProcessingPage" class="page text-center">
            <div class="header-bar">
                <h1 class="text-xl font-bold">Withdrawal Processing</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-6">
                <svg class="animate-spin h-16 w-16 text-yellow-400 mx-auto mb-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="text-2xl font-bold mb-3">24-Hour Confirmation Period</h2>
                <p class="text-gray-400 mb-6">Your withdrawal is being processed securely on the blockchain.</p>
                
                <div class="bg-gray-900 p-5 rounded-xl text-left space-y-3 border border-gray-800">
                    <div class="flex justify-between border-b border-gray-800 pb-2">
                        <span class="text-gray-400">Remaining Time:</span>
                        <span id="withdrawalCountdownDisplay" class="font-semibold text-yellow-400">24:00:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Address:</span>
                        <span id="wpAddress" class="text-sm font-mono truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Network:</span>
                        <span id="wpNetwork" class="text-sm"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Amount:</span>
                        <span id="wpAmount" class="text-sm text-red-400"></span>
                    </div>
                </div>
                
                <button class="mt-8 w-full bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg text-md font-semibold" onclick="showPage('activitiesPage')">
                    View Withdrawal Details (Activities)
                </button>
            </div>
        </div>

        <!-- =======================================================
        9. OTHER GLOBAL PAGES
        ======================================================= -->
        
        <!-- 9.1 Wallet Page (Details) -->
        <div id="walletPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Wallet Details</h1>
                <div class="w-6"></div>
            </div>
            <div id="walletDetailsContent" class="p-4 space-y-6">
                <!-- User Account Details -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">Account Information</h3>
                    <div class="space-y-2 text-sm">
                        <p>User Account ID: <span id="walletAccountId" class="font-mono text-yellow-400"></span></p>
                        <p>Connected Address: <span id="walletConnectedAddress" class="font-mono truncate text-gray-300 max-w-[70%] inline-block"></span></p>
                        <p>Deposit Balance: <span id="walletDepositBalance" class="font-bold text-green-400"></span></p>
                    </div>
                    <button class="w-full mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-semibold" onclick="disconnectAndReturn()">
                        Disconnect Wallet
                    </button>
                </div>
                
                <!-- Security Section -->
                <div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">Security</h3>
                    <button class="w-full flex justify-between items-center py-2 text-gray-300 hover:text-yellow-400" onclick="showPage('googleAuthPage')">
                        Secure Account (Google Auth)
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <div class="h-px bg-gray-800 my-2"></div>
                    <button class="w-full flex justify-between items-center py-2 text-red-400 font-semibold hover:text-red-300" onclick="closeAccount()">
                        Close Account (Deactivate)
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 9.2 Google Auth Verification Page -->
        <div id="googleAuthPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Google Authenticator</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-6 text-center space-y-6">
                <p class="text-lg font-semibold">Scan QR Code to Link Account</p>
                <div class="bg-white p-4 rounded-xl inline-block shadow-lg">
                    <div id="authQrCode"></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 break-all">
                    <p class="text-sm text-gray-400 mb-2">Secret Key</p>
                    <p id="authSecretKey" class="font-mono text-sm text-yellow-400 break-all">Loading...</p>
                </div>
                <p class="text-sm text-gray-400">User Account ID: <span id="authAccountId" class="font-mono text-yellow-400"></span></p>
                
                <input type="number" id="authCodeInput" class="w-full px-4 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Enter 6-digit code from Google Auth">
                <button class="w-full btn-yellow px-4 py-3 rounded-lg font-semibold" onclick="verifyGoogleAuthCode()">
                    Verify Code
                </button>
                <p id="authCodeError" class="text-red-500 text-sm hidden">Invalid code. Please try again.</p>
            </div>
        </div>

        <!-- 9.3 Settings Page (Simplified) -->
        <div id="settingsPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Settings</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 space-y-4">
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">Security & Account</h3>
                    <button class="w-full text-left py-2 hover:bg-gray-800 rounded-lg px-2" onclick="showPage('googleAuthPage')">
                        Google Authenticator <span class="text-xs text-green-400 ml-2">(<span id="authStatus">Not Linked</span>)</span>
                    </button>
                    <div class="h-px bg-gray-800 my-2"></div>
                    <button class="w-full text-left py-2 text-red-400 font-semibold hover:bg-gray-800 rounded-lg px-2" onclick="closeAccount()">
                        Close Account
                    </button>
                </div>

                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <h3 class="text-lg font-semibold mb-3">Preferences</h3>
                    <div class="flex justify-between items-center py-2">
                        <span>Daily Market Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationToggle" onchange="toggleNotifications(this.checked)">
                            <div class="slider round"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 9.4 Notification Page (Binance Style) -->
        <div id="notificationPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Notifications</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 space-y-4">
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 flex justify-between items-center">
                    <span class="font-semibold">Receive Daily Market Updates</span>
                    <label class="switch">
                        <input type="checkbox" id="notificationMasterToggle" onchange="toggleNotifications(this.checked)">
                        <div class="slider round"></div>
                    </label>
                </div>

                <h3 class="text-lg font-semibold mt-6">Latest Alerts</h3>
                <div id="notificationsList" class="space-y-3">
                    <p class="text-gray-500 text-sm">No recent notifications.</p>
                </div>
            </div>
        </div>

        <!-- 9.5 Activities/Transactions Page -->
        <div id="activitiesPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Activities & Transactions</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4">
                <div id="activitiesList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">No activities recorded yet.</p>
                </div>
            </div>
        </div>

        <!-- 9.6 Support Page (Gemini Chat) -->
        <div id="supportPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Help & Support</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 pb-20">
                <h2 class="text-lg font-bold mb-4">Live Support AI Chat</h2>
                <div id="chatContent" class="bg-gray-900 p-4 rounded-xl h-96 overflow-y-scroll space-y-4 mb-4 border border-gray-800">
                    <p class="text-gray-500 text-sm">Hi! I'm your automated trading bot support assistant. How can I help you understand more about trading with the Auto-Trading Bot today?</p>
                </div>

                <div class="flex gap-2 fixed bottom-20 left-1/2 -translate-x-1/2 w-full max-w-lg px-4 pb-4">
                    <input type="text" id="chatInput" class="flex-grow px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Type your message...">
                    <button class="bg-yellow-400 text-gray-900 px-4 py-3 rounded-lg font-semibold" onclick="handleSupportChat()">
                        Send
                    </button>
                </div>

                <h2 class="text-lg font-bold mt-8 mb-4">FAQ</h2>
                <div class="space-y-3 text-sm text-gray-300">
                    <p class="bg-gray-900 p-3 rounded-lg border border-gray-800">What is the daily return rate? <span class="text-yellow-400">(7.95% daily for simulation)</span></p>
                    <p class="bg-gray-900 p-3 rounded-lg border border-gray-800">How long does withdrawal take? <span class="text-yellow-400">(24 hours processing time)</span></p>
                    <p class="bg-gray-900 p-3 rounded-lg border border-gray-800">How do I connect my wallet? <span class="text-yellow-400">(Use WalletConnect or Manual Address on the connection page)</span></p>
                </div>
            </div>
        </div>

        <!-- 9.7 Trade Select Asset Page -->
        <div id="tradeSelectAssetPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('tradePage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Select Trade Asset</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4">
                <p class="text-gray-400 mb-4">Select an asset to trade with. Chart will be updated automatically.</p>
                <div id="tradeAssetList" class="space-y-3">
                    <button class="trade-asset-btn w-full text-left py-3 px-4 bg-gray-900 hover:bg-gray-800 rounded-lg" data-asset="BINANCE:BTCUSDT">BTC/USDT</button>
                    <button class="trade-asset-btn w-full text-left py-3 px-4 bg-gray-900 hover:bg-gray-800 rounded-lg" data-asset="BINANCE:ETHUSDT">ETH/USDT</button>
                    <button class="trade-asset-btn w-full text-left py-3 px-4 bg-gray-900 hover:bg-gray-800 rounded-lg" data-asset="BINANCE:BNBUSDT">BNB/USDT</button>
                </div>
            </div>
        </div>

        <!-- 9.8 Trade Duration Page -->
        <div id="tradeDurationPage" class="page">
            <div class="header-bar">
                <button onclick="showPage('tradePage')" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Select Trade Duration</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4">
                <p class="text-gray-400 mb-4">Trade Asset: <span id="tradeDurationAsset" class="font-semibold text-yellow-400"></span></p>
                <p class="text-sm text-gray-500 mb-6">Select duration. Trade ends automatically when the period is over. Daily return is 7.95% (Simulated).</p>
                <div id="durationList" class="space-y-3">
                    <!-- Durations loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- 9.9 Trade Transfer Page -->
        <div id="tradeTransferPage" class="page">
            <div class="header-bar">
                <button onclick="goBack()" class="text-yellow-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h1 class="text-xl font-bold">Transfer Funds</h1>
                <div class="w-6"></div>
            </div>
            <div class="p-4 pt-6 bg-gray-900 m-4 rounded-xl space-y-4">
                <h3 class="font-semibold text-lg text-gray-200">Main Wallet â‡„ Trade Account</h3>

                <input type="number" id="transferAmount" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400" placeholder="Enter amount to transfer (USD)">
                <p class="text-xs text-gray-500">Available Main Balance: $<span id="availableMainBalance">0.00</span> | Available Trade Balance: $<span id="availableTradeBalance">0.00</span></p>

                <div>
                    <label for="transferDirection" class="block text-sm font-medium text-gray-400 mb-1">Transfer Direction</label>
                    <select id="transferDirection" class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-yellow-400">
                        <option value="main_to_trade">Transfer to Trade Account</option>
                        <option value="trade_to_main">Transfer to Main Wallet</option>
                    </select>
                </div>

                <button class="w-full btn-yellow px-4 py-3 rounded-lg font-semibold" onclick="handleTransfer()">
                    Transfer
                </button>
            </div>
        </div>
        
    </div> <!-- End Global App Container -->

    <!-- Global Footer Navigation (Fixed) -->
    <footer id="global-footer" class="nav-footer hidden">
        <div class="flex justify-around items-center h-16">
            <button class="flex flex-col items-center text-xs text-gray-400 nav-tab" data-page="home" onclick="showPage('home')">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Home
            </button>
            <button class="flex flex-col items-center text-xs text-gray-400 nav-tab" data-page="marketPage" onclick="showPage('marketPage')">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M18 21v-4a4 4 0 00-4-4H6a4 4 0 00-4 4v4M12 2v10"></path></svg>
                Market
            </button>
            <button class="flex flex-col items-center text-xs text-gray-400 nav-tab" data-page="tradePage" onclick="showPage('tradePage')">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Trade
            </button>
            <button class="flex flex-col items-center text-xs text-gray-400 nav-tab" data-page="walletPage" onclick="showPage('walletPage')">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a4 4 0 110-8 4 4 0 010 8z"></path></svg>
                Wallet
            </button>
        </div>
    </footer>

    <!-- CSS for Toggle Switch (Settings Page) -->
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--accent-yellow);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 20px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
    </style>

    <script>
        // =======================================================
        // 0. GLOBAL CONSTANTS, STATE, AND PERSISTENCE
        // =======================================================
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const TRADINGVIEW_SYMBOL = 'BINANCE:BTCUSDT';

        // Web3 Connection Details (as provided)
        const WALLET_CONNECT_PROJECT_ID = 'cedd3cec8430b2990ce3fe466ecb1a29';
        const INFURA_ID = 'c35d1ef971da479b918c9900134867d4';
        const WEB3_API_KEY = '0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204'; // Not directly used in Web3Modal config, but listed for completeness

        // Gemini API Configuration (Simulated Fetch Structure)
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const GEMINI_API_KEY = ""; // Left blank as required

        // Deposit/Withdrawal Codes
        const WITHDRAWAL_CODES = ["483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", "356701", "740528"];
        const DEPOSIT_CODES = [482915, 930472, 158203, 764981, 502319, 847261, 319586, 672450, 248391, 905836, 731258, 629047, 580124, 417902, 896351, 264098, 152983, 309472, 741826, 589320, 620583, 958210, 203874, 742985, 894621, 510293, 673420, 248765, 901632, 437892];
        const DEPOSIT_NETWORKS = { USDT: ['Ethereum', 'Tron', 'BSC'], BTC: ['Bitcoin'], ETH: ['Ethereum'], BNB: ['BNB Smart Chain'], TRX: ['Tron'] };
        const DEPOSIT_ADDRESSES = { 'ETHEREUM': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130', 'TRON': 'TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco', 'BSC': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130', 'BITCOIN': 'bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu' };
        
        const TRADE_DAILY_RATE = 0.0795; // 7.95% daily return

        // Global State (Persisted)
        let appState = {
            isLoggedIn: false,
            walletAddress: '',
            walletId: '', // 10-digit ID
            currentPage: 'landingPage',
            history: ['landingPage'],
            balances: {
                totalUSD: 0.0,
                tradeUSD: 0.0,
                holdings: { 'USDT': { amount: 0.0, logo: 'https://assets.coingecko.com/coins/images/325/large/Tether.png' } },
            },
            trade: {
                active: false,
                asset: TRADINGVIEW_SYMBOL,
                startTime: null,
                durationMonths: 0,
                initialTradeBalance: 0.0,
                tradeReturnsUSD: 0.0,
            },
            withdrawal: {
                status: 'None', // None, Processing, Suspended
                endTime: null, // For processing/suspension countdown
                details: null,
                attempts: 0,
            },
            auth: {
                googleAuthLinked: false,
                secretKey: null,
            },
            notifications: {
                enabled: true,
                lastUpdateTimestamp: 0,
                messages: [],
            },
            activities: [],
            marketData: {
                topCoins: [],
                overview: null,
            }
        };

        let deferredPrompt; // PWA Install Prompt event

        // Web3modal/Provider Instances
        let web3Modal;
        let provider;
        let web3;
        
        let allCoins = []; // Cache for CoinGecko coin list (A-Z)
        let selectedDepositCoin = null; 
        let currentDeposit = {}; 
        let currentWithdrawal = {}; 

        // =======================================================
        // 1. UTILITIES: State Management, UI, and Async
        // =======================================================

        function saveState() {
            localStorage.setItem('appState', JSON.stringify(appState));
        }

        function loadState() {
            const persistedState = localStorage.getItem('appState');
            if (persistedState) {
                const loadedState = JSON.parse(persistedState);
                // Merge loaded state, ensuring no corruption on initial load of new properties
                appState = { ...appState, ...loadedState };
                appState.balances.holdings = { ...appState.balances.holdings, ...loadedState.balances.holdings };
                appState.trade = { ...appState.trade, ...loadedState.trade };
                appState.withdrawal = { ...appState.withdrawal, ...loadedState.withdrawal };
                appState.auth = { ...appState.auth, ...loadedState.auth };
                appState.notifications = { ...appState.notifications, ...loadedState.notifications };
            }
        }

        function showPage(pageId, silent = false) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });

            // Show target page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                document.body.scrollTop = document.documentElement.scrollTop = 0;
            }

            // Update app state and history for back button/persistence
            if (!silent && appState.currentPage !== pageId) {
                appState.history.push(appState.currentPage);
                appState.history = appState.history.slice(-10); // Keep history short
            }
            appState.currentPage = pageId;
            saveState();

            // Toggle footer visibility
            const footer = document.getElementById('global-footer');
            if (pageId === 'home' || pageId === 'marketPage' || pageId === 'tradePage' || pageId === 'walletPage') {
                footer.classList.remove('hidden');
            } else {
                footer.classList.add('hidden');
            }
            
            // Render specific page data
            if (appState.isLoggedIn) {
                renderHomeUI();
                if (pageId === 'walletPage') renderWalletUI();
                if (pageId === 'marketPage') loadMarketData();
                if (pageId === 'activitiesPage') renderActivities();
                if (pageId === 'depositCoinSelectPage') loadDepositCoins();
                if (pageId === 'settingsPage') renderSettingsUI();
                if (pageId === 'notificationPage') renderNotificationsUI();
                if (pageId === 'tradePage') renderTradeUI();
                if (pageId === 'tradeTransferPage') renderTransferUI();
                if (pageId === 'googleAuthPage') setupGoogleAuthUI();

                // Re-init chart for specific pages to ensure it loads
                if (pageId === 'home') initializeTradingViewChart('tvchart', TRADINGVIEW_SYMBOL);
                if (pageId === 'tradePage') initializeTradingViewChart('tradeLiveChart', appState.trade.asset);
            }
        }

        function goBack() {
            if (appState.history.length > 0) {
                const lastPage = appState.history.pop();
                showPage(lastPage, true);
            } else {
                showPage('landingPage');
            }
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let colorClass = 'bg-gray-700';
            if (type === 'success') colorClass = 'bg-green-600';
            if (type === 'error') colorClass = 'bg-red-600';
            if (type === 'warning') colorClass = 'bg-yellow-600';

            toast.className = `p-3 rounded-lg text-white shadow-lg mb-3 ${colorClass}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function waitFor(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // =======================================================
        // 2. AUTHENTICATION & WALLET CONNECTION
        // =======================================================

        function generateWalletId() {
            // Generate a 10-digit unique ID
            return Math.floor(1000000000 + Math.random() * 9000000000).toString();
        }

        function shortenAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }
        
        async function initWeb3Modal() {
            const providerOptions = {
                walletconnect: {
                    package: WalletConnectProvider.default,
                    options: {
                        infuraId: INFURA_ID,
                        projectId: WALLET_CONNECT_PROJECT_ID,
                    }
                }
                // Add other providers like Metamask here if required
            };

            web3Modal = new Web3Modal.default({
                cacheProvider: false, // Don't auto-cache for this scenario
                providerOptions,
                theme: "dark"
            });
        }

        async function connectWallet() {
            showLoading("Connecting wallet...");
            await initWeb3Modal();
            try {
                // This is where Web3Modal opens the QR/modal
                provider = await web3Modal.connect();
                web3 = new Web3(provider);
                const accounts = await web3.eth.getAccounts();
                const address = accounts[0];
                
                appState.walletAddress = address;
                appState.walletId = generateWalletId();
                saveState();

                // Open Confirmation Modal after connection
                hideLoading();
                document.getElementById('confirmConnectionModal').classList.remove('hidden');

            } catch (error) {
                console.error("Could not get a wallet connection", error);
                hideLoading();
                showToast("Wallet connection failed or was cancelled.", 'error');
            }
        }
        
        async function manualConnect() {
            const address = document.getElementById('manualAddressInput').value.trim();
            const statusElem = document.getElementById('manualStatus');

            if (!address) {
                statusElem.textContent = "Please enter a wallet address.";
                statusElem.classList.add('text-red-500');
                return;
            }
            
            statusElem.classList.remove('text-red-500');
            statusElem.textContent = "Connecting and fetching balances...";
            
            showLoading("Connecting wallet and generating ID (15s)...");
            await waitFor(15000); // Simulate connection/fetch time

            // Simulation: Assume successful connection
            appState.walletAddress = address;
            appState.walletId = generateWalletId();
            
            hideLoading();
            document.getElementById('confirmConnectionModal').classList.remove('hidden');
        }

        async function handleConfirmedConnection() {
            document.getElementById('confirmConnectionModal').classList.add('hidden');
            appState.isLoggedIn = true;
            saveState();
            
            showToast("Wallet connected! ID generated.", 'success');
            
            // Redirect to home and persist the new page
            showPage('home');
        }

        async function loginWithID() {
            const inputId = document.getElementById('accountIdInput').value.trim();
            if (!inputId || inputId.length !== 10) {
                showToast("Please enter a valid 10-digit Account ID.", 'error');
                return;
            }

            showLoading("Logging in (15s)...");
            await waitFor(15000);

            // Log in logic: check if ID matches the stored one
            if (inputId === appState.walletId && appState.walletAddress) {
                appState.isLoggedIn = true;
                saveState();
                hideLoading();
                showToast("Log in successful.", 'success');
                showPage('home');
            } else if (appState.walletId && appState.walletAddress === '' && inputId === appState.walletId) {
                 // Case for deactivated account (walletAddress is cleared but ID is kept)
                hideLoading();
                showToast("Account deactivated. Please reconnect a wallet.", 'error');
            } 
            else {
                hideLoading();
                showToast("Login ID invalid or account not found. Connect wallet to get an ID.", 'error');
            }
        }

        async function disconnectAndReturn() {
            showLoading("Disconnecting wallet (15s)...");
            
            // Clear all web3-related variables
            if (web3Modal) web3Modal.clearCachedProvider();
            
            // Clear user-specific state that requires login
            appState.isLoggedIn = false;
            appState.walletAddress = '';
            appState.currentPage = 'landingPage';
            appState.history = ['landingPage'];
            
            saveState();
            await waitFor(15000);
            
            hideLoading();
            showToast("Disconnected. Use your ID to log back in.", 'info');
            showPage('landingPage');
        }

        async function closeAccount() {
            showLoading("Disconnecting wallet and deactivating account (15s)...");
            
            // Clear all sensitive data and log out
            if (web3Modal) web3Modal.clearCachedProvider();
            
            appState.isLoggedIn = false;
            appState.walletAddress = ''; // Deactivates the ID for future login attempts
            appState.currentPage = 'landingPage';
            appState.history = ['landingPage'];
            appState.balances = { totalUSD: 0.0, tradeUSD: 0.0, holdings: { 'USDT': { amount: 0.0, logo: 'https://assets.coingecko.com/coins/images/325/large/Tether.png' } } };
            
            saveState();
            await waitFor(15000);

            hideLoading();
            showToast("Account deactivated and data cleared.", 'warning');
            showPage('landingPage');
        }
        
        // =======================================================
        // 3. UI RENDERING AND LIVE DATA FETCHING
        // =======================================================
        
        function renderHomeUI() {
            // Update Balance Display
            document.getElementById('totalBalanceUSD').textContent = formatCurrency(appState.balances.totalUSD);
            document.getElementById('userIdDisplay').textContent = `ID: ${appState.walletId || 'N/A'}`;
            
            // Update Token Holdings
            const holdingsList = document.getElementById('tokenHoldingsList');
            holdingsList.innerHTML = '';
            
            let hasHoldings = false;
            for (const symbol in appState.balances.holdings) {
                const holding = appState.balances.holdings[symbol];
                if (holding.amount > 0) {
                    hasHoldings = true;
                    holdingsList.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center gap-3">
                                <img src="${holding.logo}" class="w-8 h-8 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${symbol.substring(0,2).toUpperCase()}'" />
                                <div>
                                    <p class="font-semibold">${symbol.toUpperCase()}</p>
                                    <p class="text-xs text-gray-400">Balance: ${holding.amount.toFixed(4)}</p>
                                </div>
                            </div>
                            <span class="font-bold">${formatCurrency(holding.amount * (appState.marketData.prices?.[symbol.toLowerCase()]?.usd || 1))}</span>
                        </div>
                    `;
                }
            }
            if (!hasHoldings) {
                holdingsList.innerHTML = '<p class="text-gray-400 text-sm">No tokens held. Deposit to get started.</p>';
            }

            // Update Activities
            renderActivities('homeActivitiesList', 4);
            
            // Update Trade Suspension Banner
            checkWithdrawalSuspension();
        }
        
        function renderWalletUI() {
            document.getElementById('walletAccountId').textContent = appState.walletId || 'N/A';
            document.getElementById('walletConnectedAddress').textContent = shortenAddress(appState.walletAddress) || 'N/A';
            document.getElementById('walletDepositBalance').textContent = formatCurrency(appState.balances.totalUSD);
            document.getElementById('authStatus').textContent = appState.auth.googleAuthLinked ? 'Linked' : 'Not Linked';
        }
        
        function renderActivities(elementId = 'activitiesList', limit = Infinity) {
            const list = document.getElementById(elementId);
            if (!list) return;

            if (appState.activities.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No activities recorded yet.</p>';
                return;
            }

            const html = appState.activities.slice(0, limit).map(activity => {
                const date = new Date(activity.date).toLocaleDateString();
                const time = new Date(activity.date).toLocaleTimeString();
                let color = 'text-gray-300';
                if (activity.status === 'Success') color = 'text-green-400';
                if (activity.status === 'Processing') color = 'text-yellow-400';
                if (activity.status === 'Failed') color = 'text-red-400';

                let countdownHtml = '';
                if (activity.type === 'Withdrawal' && activity.status === 'Processing') {
                    const remaining = calculateTimeRemaining(activity.endTime);
                    countdownHtml = `<span class="ml-2 font-mono text-xs text-yellow-500">${remaining.hours.toString().padStart(2, '0')}:${remaining.minutes.toString().padStart(2, '0')}:${remaining.seconds.toString().padStart(2, '0')} remaining</span>`;
                }

                return `
                    <div class="flex flex-col p-3 bg-gray-800 rounded-lg border-l-4 border-${activity.status === 'Success' ? 'green-500' : (activity.status === 'Processing' ? 'yellow-500' : 'red-500')}">
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-semibold ${color}">${activity.type} (${activity.status})</span>
                            <span class="text-xs text-gray-500">${date} ${time}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 break-words">${activity.desc}${countdownHtml}</p>
                    </div>
                `;
            }).join('');
            
            list.innerHTML = html;
        }

        async function fetchMarketData(loadType = 'home') {
            try {
                const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false`);
                if (!response.ok) throw new Error('Failed to fetch market data');
                
                const data = await response.json();
                appState.marketData.topCoins = data;
                
                // Extract prices for quick lookup
                appState.marketData.prices = {};
                data.forEach(coin => {
                    appState.marketData.prices[coin.symbol.toLowerCase()] = { usd: coin.current_price, change: coin.price_change_percentage_24h };
                });
                
                // Fetch simple overview data for market page
                const overviewRes = await fetch(`${COINGECKO_API}/global`);
                const overviewData = await overviewRes.json();
                appState.marketData.overview = overviewData.data;

                saveState();

                if (loadType === 'home') renderLandingAndHomeMarketLists(data.slice(0, 5), 'homeMarketList');
                if (loadType === 'landingPage') renderLandingAndHomeMarketLists(data.slice(0, 5), 'topCoinsList');
                if (loadType === 'marketPage' || loadType === 'gainers' || loadType === 'losers') renderMarketCoinList(data, loadType);
                
                // Update market overview text
                if (appState.marketData.overview) {
                    const overviewText = `Total Cryptos: ${appState.marketData.overview.active_cryptocurrencies.toLocaleString()} | Markets: ${appState.marketData.overview.markets.toLocaleString()} | 24h Volume: ${formatCurrency(appState.marketData.overview.total_volume.usd)}`;
                    document.getElementById('marketPageOverview').textContent = overviewText;
                }
                
                renderHomeUI(); // Update holdings with new prices

            } catch (error) {
                console.error("Error fetching market data:", error);
                if (loadType === 'home') document.getElementById('homeMarketList').innerHTML = '<p class="text-red-500 text-xs text-center">Failed to load market data.</p>';
                if (loadType === 'landingPage') document.getElementById('topCoinsList').innerHTML = '<p class="text-red-500 text-xs text-center">Failed to load market data.</p>';
            }
        }
        
        function renderLandingAndHomeMarketLists(coins, elementId) {
            const list = document.getElementById(elementId);
            if (!list) return;

            list.innerHTML = coins.map(coin => {
                const change = coin.price_change_percentage_24h_in_currency || coin.price_change_percentage_24h || 0;
                const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
                const changeSign = change >= 0 ? '+' : '';

                return `
                    <div class="flex items-center justify-between cursor-pointer hover:bg-gray-700 p-2 rounded-lg" onclick="initializeTradingViewChart('tvchart', 'BINANCE:${coin.symbol.toUpperCase()}USDT')">
                        <div class="flex items-center gap-3 w-1/3">
                            <img src="${coin.image}" class="w-6 h-6 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" />
                            <p class="font-semibold text-sm">${coin.symbol.toUpperCase()}</p>
                        </div>
                        <span class="font-bold text-sm w-1/3 text-right">${formatCurrency(coin.current_price)}</span>
                        <span class="text-sm w-1/3 text-right ${changeColor}">${changeSign}${change.toFixed(2)}%</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderMarketCoinList(coins, filter) {
            let filteredCoins = [...coins];
            if (filter === 'gainers') {
                filteredCoins.sort((a, b) => (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0));
            } else if (filter === 'losers') {
                filteredCoins.sort((a, b) => (a.price_change_percentage_24h || 0) - (b.price_change_percentage_24h || 0));
            } else {
                // Alphabetical (A-Z) by name if no filter
                filteredCoins.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            const list = document.getElementById('marketCoinList');
            if (!list) return;

            list.innerHTML = filteredCoins.map(coin => {
                const change = coin.price_change_percentage_24h || 0;
                const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
                const changeSign = change >= 0 ? '+' : '';

                return `
                    <div class="flex items-center py-3 cursor-pointer hover:bg-gray-800" onclick="initializeTradingViewChart('tvchart', 'BINANCE:${coin.symbol.toUpperCase()}USDT'); showPage('home');">
                        <div class="flex items-center gap-2 w-1/3">
                            <img src="${coin.image}" class="w-6 h-6 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" />
                            <div>
                                <p class="font-semibold text-sm">${coin.symbol.toUpperCase()}</p>
                                <p class="text-xs text-gray-500">${coin.name}</p>
                            </div>
                        </div>
                        <span class="font-bold text-sm w-1/3 text-right">${formatCurrency(coin.current_price)}</span>
                        <span class="text-sm w-1/3 text-right ${changeColor}">${changeSign}${change.toFixed(2)}%</span>
                    </div>
                `;
            }).join('');
        }
        
        function initializeTradingViewChart(containerId, symbol) {
            if (typeof TradingView === 'undefined') {
                console.warn('TradingView library not yet loaded.');
                return;
            }
            
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear existing chart instance if any (important for dynamic updates)
            container.innerHTML = '';
            
            new TradingView.widget({
                "container_id": containerId,
                "symbol": symbol,
                "interval": "60",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": true,
                "allow_symbol_change": true,
                "save_image": false,
                "autosize": true,
                "studies": ["Moving Average"],
                "width": container.offsetWidth,
                "height": 300, // Fixed height for mobile view
            });
        }
        
        // =======================================================
        // 4. TRADE LOGIC (Simulation)
        // =======================================================
        
        function renderTradeUI() {
            document.getElementById('totalTradeBalanceUSD').textContent = formatCurrency(appState.balances.tradeUSD);
            document.getElementById('totalTradeReturns').textContent = formatCurrency(appState.trade.tradeReturnsUSD);
            document.getElementById('currentTradeAsset').textContent = appState.trade.asset.split(':')[1] || TRADINGVIEW_SYMBOL.split(':')[1];
            
            const tradePanel = document.getElementById('tradeStatusPanel');
            const countdownDisplay = document.getElementById('tradeCountdownDisplay');

            if (appState.trade.active) {
                tradePanel.classList.remove('hidden');
                updateTradeReturns();
                startTradeCountdown();
            } else {
                tradePanel.classList.add('hidden');
                countdownDisplay.textContent = 'No active trade. Place a new trade to start generating returns.';
            }
        }
        
        function updateTradeReturns() {
            if (!appState.trade.active || !appState.trade.startTime) return;
            
            const now = new Date().getTime();
            const start = appState.trade.startTime;
            
            // Time elapsed in milliseconds
            const elapsedMs = now - start;
            const msPerDay = 24 * 60 * 60 * 1000;
            
            // Total days elapsed
            const elapsedDays = elapsedMs / msPerDay;
            
            // Simple interest calculation (compound for persistence)
            // Daily returns = (Initial Balance) * (1 + Daily Rate)^Days - Initial Balance
            const tradeReturns = appState.trade.initialTradeBalance * (Math.pow(1 + TRADE_DAILY_RATE, elapsedDays) - 1);
            
            appState.trade.tradeReturnsUSD = tradeReturns;
            
            // Update UI
            document.getElementById('totalTradeReturns').textContent = formatCurrency(appState.trade.tradeReturnsUSD);
            
            // Check for end of trade duration
            const durationMs = appState.trade.durationMonths * 30 * msPerDay;
            if (elapsedMs >= durationMs) {
                endTradeSimulation();
            }
            
            saveState();
        }

        function startTradeCountdown() {
            // Calculate remaining time for the trade
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const msPerDay = 24 * 60 * 60 * 1000;
                const durationMs = appState.trade.durationMonths * 30 * msPerDay;
                const endTimestamp = appState.trade.startTime + durationMs;
                const remainingMs = endTimestamp - now;
                
                const display = document.getElementById('tradeCountdownDisplay');
                
                if (remainingMs <= 0) {
                    clearInterval(interval);
                    display.textContent = 'Trade ended. Total earnings transferred.';
                    endTradeSimulation();
                    return;
                }
                
                const remaining = calculateTimeRemaining(endTimestamp);
                display.textContent = `Duration: ${appState.trade.durationMonths} months | Remaining: ${remaining.days}d ${remaining.hours.toString().padStart(2, '0')}:${remaining.minutes.toString().padStart(2, '0')}:${remaining.seconds.toString().padStart(2, '0')}`;
                
                updateTradeReturns(); // Update returns every second
            }, 1000);
            
            // Store the interval ID on the window object to stop on refresh/navigation if needed
            window.tradeIntervalId = interval;
        }
        
        function endTradeSimulation() {
            if (window.tradeIntervalId) {
                clearInterval(window.tradeIntervalId);
                window.tradeIntervalId = null;
            }

            if (!appState.trade.active) return;
            
            const totalEarnings = appState.trade.initialTradeBalance + appState.trade.tradeReturnsUSD;
            
            // Transfer initial balance + earnings to main wallet
            appState.balances.totalUSD += totalEarnings;
            
            // Reset trade state
            appState.trade.active = false;
            appState.trade.startTime = null;
            appState.trade.durationMonths = 0;
            appState.trade.initialTradeBalance = 0.0;
            appState.trade.tradeReturnsUSD = 0.0;
            
            // Add activity
            appState.activities.unshift({
                type: 'Trade End',
                desc: `Trade completed. Total earnings of ${formatCurrency(totalEarnings)} transferred to main wallet.`,
                date: new Date().toISOString(),
                status: 'Success'
            });
            
            saveState();
            renderHomeUI();
            renderTradeUI();
            showToast(`Trade successful! ${formatCurrency(totalEarnings)} earned.`, 'success');
        }

        function handlePlaceTrade() {
            if (appState.trade.active) {
                showToast("An active trade is currently running. Please wait for it to complete.", 'warning');
                return;
            }
            if (appState.balances.tradeUSD <= 0) {
                showToast("Your Trade Account balance is $0.00. Please deposit or transfer funds first.", 'error');
                // Open Transfer page
                showPage('tradeTransferPage');
                return;
            }
            
            // If balance > 0, navigate to asset selection
            showPage('tradeSelectAssetPage');
        }

        // ----------------- Trade Flow Step 2/3: Asset Selection -----------------
        function setupTradeAssetListeners() {
            document.querySelectorAll('.trade-asset-btn').forEach(btn => {
                btn.onclick = () => {
                    const asset = btn.dataset.asset;
                    appState.trade.asset = asset;
                    
                    // Immediately load duration page
                    renderTradeDurationUI(asset);
                    showPage('tradeDurationPage');
                };
            });
        }
        
        // ----------------- Trade Flow Step 3/3: Duration Selection -----------------
        function renderTradeDurationUI(asset) {
            document.getElementById('tradeDurationAsset').textContent = asset.split(':')[1];
            const durationList = document.getElementById('durationList');
            durationList.innerHTML = '';
            
            const durations = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            
            durations.forEach(month => {
                durationList.innerHTML += `
                    <button class="w-full text-left py-3 px-4 bg-gray-900 hover:bg-gray-800 rounded-lg" data-duration="${month}" onclick="startNewTrade(${month})">
                        ${month} Month${month > 1 ? 's' : ''}
                    </button>
                `;
            });
        }
        
        async function startNewTrade(durationMonths) {
            if (appState.balances.tradeUSD <= 0) {
                showToast("Trade balance is zero. Transfer funds before starting.", 'error');
                showPage('tradePage');
                return;
            }
            
            showLoading(`Activating bot for ${durationMonths} months (15s)...`);
            await waitFor(15000); // Simulate order placement
            
            appState.trade.active = true;
            appState.trade.startTime = new Date().getTime();
            appState.trade.durationMonths = durationMonths;
            appState.trade.initialTradeBalance = appState.balances.tradeUSD;
            
            // Dedicate all trade balance to the trade (preventing further trades)
            // We keep it in tradeUSD for display but use initialTradeBalance for calculation
            
            appState.activities.unshift({
                type: 'Trade Start',
                desc: `Bot started trading ${appState.trade.asset} with ${formatCurrency(appState.trade.initialTradeBalance)} for ${durationMonths} months.`,
                date: new Date().toISOString(),
                status: 'Success'
            });
            
            saveState();
            hideLoading();
            showToast("Trade activated! Returns will now be generated daily.", 'success');
            
            // Go back to the trade page to see the countdown
            showPage('tradePage');
            startTradeCountdown();
        }
        
        // ----------------- Transfer Logic -----------------
        function renderTransferUI() {
            document.getElementById('availableMainBalance').textContent = appState.balances.totalUSD.toFixed(2);
            document.getElementById('availableTradeBalance').textContent = appState.balances.tradeUSD.toFixed(2);
        }
        
        async function handleTransfer() {
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const direction = document.getElementById('transferDirection').value;

            if (isNaN(amount) || amount <= 0) {
                showToast("Please enter a valid amount.", 'error');
                return;
            }

            if (direction === 'main_to_trade') {
                if (amount > appState.balances.totalUSD) {
                    showToast("Insufficient Main Wallet balance.", 'error');
                    return;
                }
                showLoading("Transfer processing (15s)...");
                await waitFor(15000);
                
                appState.balances.totalUSD -= amount;
                appState.balances.tradeUSD += amount;
                
                appState.activities.unshift({
                    type: 'Transfer',
                    desc: `Transferred ${formatCurrency(amount)} from Main Wallet to Trade Account.`,
                    date: new Date().toISOString(),
                    status: 'Success'
                });
                
                showToast(`Successfully transferred ${formatCurrency(amount)} to Trade Account.`, 'success');

            } else if (direction === 'trade_to_main') {
                if (amount > appState.balances.tradeUSD) {
                    showToast("Insufficient Trade Account balance.", 'error');
                    return;
                }
                if (appState.trade.active) {
                    showToast("Cannot transfer funds out while a trade is active.", 'error');
                    return;
                }
                
                showLoading("Transfer processing (15s)...");
                await waitFor(15000);
                
                appState.balances.tradeUSD -= amount;
                appState.balances.totalUSD += amount;
                
                appState.activities.unshift({
                    type: 'Transfer',
                    desc: `Transferred ${formatCurrency(amount)} from Trade Account to Main Wallet.`,
                    date: new Date().toISOString(),
                    status: 'Success'
                });
                
                showToast(`Successfully transferred ${formatCurrency(amount)} to Main Wallet.`, 'success');
            }

            saveState();
            hideLoading();
            renderTransferUI();
            showPage('home'); // Redirect to home after transfer
        }


        // =======================================================
        // 5. DEPOSIT LOGIC (Fully Updated & Working)
        // =======================================================

        async function loadDepositCoins() {
            const depositCoinList = document.getElementById('depositCoinList');
            if (!depositCoinList) return; 
            depositCoinList.innerHTML = `<p class="text-center text-gray-400 py-4">Loading coins...</p>`; 
            try {
                if (allCoins.length === 0) {
                    const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('Failed to fetch deposit coins');
                    allCoins = await response.json();
                } 
                allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort Aâ€“Z
                renderDepositCoinList(allCoins);
            } catch (error) {
                console.error("Error loading deposit coins:", error);
                depositCoinList.innerHTML = `<p class="text-center text-red-500 py-4">Failed to load coins. Please try again later.</p>`;
            } 
            
            // Attach live search
            const searchInput = document.getElementById('depositSearch');
            if (searchInput) {
                searchInput.oninput = (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (!searchTerm) {
                        renderDepositCoinList(allCoins);
                        return;
                    }
                    const filtered = allCoins.filter(
                        c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm)
                    );
                    renderDepositCoinList(filtered);
                };
            }
        } 

        function renderDepositCoinList(coins) {
            const container = document.getElementById('depositCoinList');
            if (!container) return; 
            
            if (!coins || coins.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 py-4">No matching coins found.</p>`;
                return;
            } 
            
            let html = coins.map(coin => `
                <div class="deposit-coin-item flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-800 hover:bg-gray-800 cursor-pointer"
                    data-symbol="${coin.symbol.toUpperCase()}" 
                    data-name="${coin.name}" 
                    data-id="${coin.id}" 
                    data-image="${coin.image}"
                    onclick="selectDepositCoin('${coin.symbol.toUpperCase()}', '${coin.image}')">
                    <div class="flex items-center gap-3">
                        <img src="${coin.image}" class="w-8 h-8 rounded-full"
                            onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" />
                        <div>
                            <p class="font-semibold">${coin.symbol.toUpperCase()}</p>
                            <p class="text-xs text-gray-400">${coin.name}</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            `).join('');
            
            container.innerHTML = html; 
        } 

        function selectDepositCoin(symbol, image) {
            selectedDepositCoin = { symbol, image };
            document.getElementById('depositCoinName').textContent = symbol;
            document.getElementById('depositAddressCoin').textContent = symbol;
            renderNetworkSelection(symbol);
            showPage('depositNetworkPage');
        }

        function renderNetworkSelection(coinSymbol) {
            const container = document.getElementById('networkSelectionList');
            if (!container) return; 
            
            const networks = DEPOSIT_NETWORKS[coinSymbol] || ['Ethereum'];
            container.innerHTML = networks.map(network => `
                <button class="network-select-btn w-full flex items-center py-4 px-5 bg-gray-900 border border-gray-700 rounded-xl hover:bg-gray-800 transition"
                    data-network="${network}"
                    onclick="openDepositAddressPage('${coinSymbol}', '${network}')">
                    <span class="text-md font-semibold">${network}</span>
                    <svg class="w-5 h-5 ml-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            `).join(''); 
        } 

        function openDepositAddressPage(symbol, network) {
            const address = DEPOSIT_ADDRESSES[network.toUpperCase().replace(/\s/g, '')];
            if (!address) {
                showToast(`No deposit address found for ${symbol} on ${network}.`, 'error');
                return;
            } 
            
            currentDeposit = { coin: symbol, network, address };
            showPage('depositAddressPage');  
            document.getElementById('depositNetworkHeader').textContent = network;
            document.getElementById('depositAddressDisplay').textContent = address; 
            
            // Generate QR code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: address,
                width: 160,
                height: 160,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        } 

        function copyDepositAddress() {
            const address = document.getElementById('depositAddressDisplay').textContent;
            if (!address) return; 
            
            // Fallback for secure copy in iframe environments
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = address;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast('Address copied to clipboard!', 'success');
            } catch (err) {
                 showToast('Failed to copy address.', 'error');
            }
        } 

        function showDepositConfirmationPage() {
            const amountInput = document.getElementById('depositAmountInput');
            
            // If coming from the address page, the user hasn't entered an amount yet.
            // We just move to the confirmation page and rely on the user filling the form.
            showPage('depositConfirmPage');
        } 

        async function handleDepositConfirmation() {
            const amount = parseFloat(document.getElementById('depositAmountInput').value);
            const code = parseInt(document.getElementById('depositVerificationCode').value);
            const errorMsg = document.getElementById('depositCodeError');
            
            errorMsg.classList.add('hidden');

            if (isNaN(amount) || amount <= 0) {
                errorMsg.textContent = 'Please enter a valid deposit amount.';
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!code || code.toString().length !== 6) {
                errorMsg.textContent = 'Enter your 6-digit verification code.';
                errorMsg.classList.remove('hidden');
                return;
            } 

            currentDeposit.amount = amount;
            
            showLoading('Processing deposit (15s)...');
            await waitFor(15000); 

            if (!DEPOSIT_CODES.includes(code)) {
                hideLoading();
                errorMsg.textContent = 'Invalid or used verification code.';
                errorMsg.classList.remove('hidden');
                return;
            } 
            
            // Success Logic
            appState.balances.totalUSD += currentDeposit.amount;
            appState.balances.tradeUSD += currentDeposit.amount;
            
            // Add the deposited coin to holdings (assuming 1 USDT = 1 USD for simplicity)
            const coinSymbol = currentDeposit.coin;
            const coinImage = selectedDepositCoin.image;
            
            if (!appState.balances.holdings[coinSymbol]) {
                appState.balances.holdings[coinSymbol] = { amount: 0, logo: coinImage };
            }
            appState.balances.holdings[coinSymbol].amount += currentDeposit.amount;
            
            appState.activities.unshift({
                type: 'Deposit',
                desc: `Deposited ${currentDeposit.amount.toFixed(2)} ${coinSymbol} via ${currentDeposit.network}.`,
                date: new Date().toISOString(),
                status: 'Success'
            }); 
            
            saveState();
            hideLoading();
            
            // Show custom success message with Add Token button (simulated as it's already added)
            showToast(`Successfully deposited ${currentDeposit.amount.toFixed(2)} ${coinSymbol}. Token added to holdings!`, 'success');
            showPage('home');
        } 

        // =======================================================
        // 6. WITHDRAWAL LOGIC (Countdown & Suspension)
        // =======================================================

        let withdrawalIntervalId;
        
        function fillFromConnectedWallet() {
            document.getElementById('withdrawalAddress').value = appState.walletAddress || '';
        }
        
        function fillMaxWithdrawal() {
            document.getElementById('withdrawalAmount').value = appState.balances.totalUSD.toFixed(2);
        }

        function toggleNetworkDropdown() {
            document.getElementById('networkDropdown').classList.toggle('hidden');
        }
        
        function selectWithdrawalNetwork(network) {
            document.getElementById('selectedNetworkDisplay').textContent = network;
            document.getElementById('networkDropdown').classList.add('hidden');
        }
        
        function showWithdrawalConfirmation() {
            const address = document.getElementById('withdrawalAddress').value.trim();
            const network = document.getElementById('selectedNetworkDisplay').textContent;
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);

            if (!address || !network || isNaN(amount) || amount <= 0) {
                showToast("Please fill out all withdrawal details correctly.", 'error');
                return;
            }
            if (amount > appState.balances.totalUSD) {
                showToast("Insufficient balance for withdrawal.", 'error');
                return;
            }
            if (appState.withdrawal.status === 'Suspended') {
                showToast("Withdrawal is suspended. Check activities page.", 'error');
                return;
            }
            if (appState.withdrawal.status === 'Processing') {
                showToast("A withdrawal is already processing.", 'warning');
                return;
            }
            
            currentWithdrawal = { address, network, amount, date: new Date().toISOString() };
            
            document.getElementById('withdrawalConfirmationModal').classList.remove('hidden');
            document.getElementById('withdrawalCodeError').classList.add('hidden');
            document.getElementById('withdrawalValidationCode').value = '';
        }
        
        async function handleWithdrawal() {
            const code = document.getElementById('withdrawalValidationCode').value.trim();
            const errorMsg = document.getElementById('withdrawalCodeError');
            
            if (!code) return;
            
            showLoading("Verifying code (15s)...");
            await waitFor(15000);
            
            if (WITHDRAWAL_CODES.includes(code)) {
                // Success - start 24-hour processing
                document.getElementById('withdrawalConfirmationModal').classList.add('hidden');
                hideLoading();
                
                appState.withdrawal.status = 'Processing';
                appState.withdrawal.endTime = new Date().getTime() + (24 * 60 * 60 * 1000); // 24 hours from now
                appState.withdrawal.details = currentWithdrawal;
                appState.withdrawal.attempts = 0; // Reset attempts on success
                
                appState.activities.unshift({
                    type: 'Withdrawal',
                    desc: `Withdrawal of ${formatCurrency(currentWithdrawal.amount)} to ${shortenAddress(currentWithdrawal.address)} started.`,
                    date: currentWithdrawal.date,
                    status: 'Processing',
                    endTime: appState.withdrawal.endTime
                });
                
                saveState();
                showToast("Withdrawal confirmed. Processing will take 24 hours.", 'info');
                showPage('withdrawalProcessingPage');
                startWithdrawalCountdown();

            } else {
                // Failure - suspension logic
                appState.withdrawal.attempts += 1;
                saveState();
                
                hideLoading();
                errorMsg.textContent = `Validation failed. Please enter correct code. Attempts left: ${5 - appState.withdrawal.attempts}`;
                errorMsg.classList.remove('hidden');

                if (appState.withdrawal.attempts >= 5) {
                    // Suspend withdrawal
                    document.getElementById('withdrawalConfirmationModal').classList.add('hidden');
                    appState.withdrawal.status = 'Suspended';
                    appState.withdrawal.endTime = new Date().getTime() + (48 * 60 * 60 * 1000); // 48 hours suspension
                    appState.withdrawal.attempts = 0;
                    
                    appState.activities.unshift({
                        type: 'Withdrawal Suspension',
                        desc: `Withdrawal function suspended for 48 hours due to too many failed attempts.`,
                        date: new Date().toISOString(),
                        status: 'Failed',
                        endTime: appState.withdrawal.endTime
                    });
                    
                    saveState();
                    showToast("Withdrawal suspended for 48 hours.", 'error');
                    showPage('home'); // Return to home to show banner
                }
            }
        }
        
        function calculateTimeRemaining(endTime) {
            const now = new Date().getTime();
            const distance = endTime - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            return { days, hours, minutes, seconds };
        }
        
        function startWithdrawalCountdown() {
            if (withdrawalIntervalId) clearInterval(withdrawalIntervalId);
            
            withdrawalIntervalId = setInterval(() => {
                if (appState.withdrawal.status !== 'Processing' && appState.withdrawal.status !== 'Suspended') {
                    clearInterval(withdrawalIntervalId);
                    return;
                }
                
                const remaining = calculateTimeRemaining(appState.withdrawal.endTime);
                
                if (appState.withdrawal.status === 'Processing') {
                    const display = document.getElementById('withdrawalCountdownDisplay');
                    if (display) display.textContent = `${remaining.hours.toString().padStart(2, '0')}:${remaining.minutes.toString().padStart(2, '0')}:${remaining.seconds.toString().padStart(2, '0')}`;
                    
                    // Update processing page details if visible
                    const wpAddress = document.getElementById('wpAddress');
                    if(wpAddress && appState.withdrawal.details) {
                        wpAddress.textContent = shortenAddress(appState.withdrawal.details.address);
                        document.getElementById('wpNetwork').textContent = appState.withdrawal.details.network;
                        document.getElementById('wpAmount').textContent = formatCurrency(appState.withdrawal.details.amount);
                    }
                    
                    if (remaining.seconds <= 0 && remaining.minutes <= 0 && remaining.hours <= 0 && remaining.days <= 0) {
                        // Withdrawal successful
                        completeWithdrawal();
                    }
                }
                
                if (appState.withdrawal.status === 'Suspended') {
                    if (remaining.seconds <= 0 && remaining.minutes <= 0 && remaining.hours <= 0 && remaining.days <= 0) {
                        // Suspension lifted
                        appState.withdrawal.status = 'None';
                        appState.withdrawal.endTime = null;
                        saveState();
                        showToast("Withdrawal suspension lifted. You may try again now.", 'success');
                        clearInterval(withdrawalIntervalId);
                        renderHomeUI();
                    }
                }
                
                // Rerender home activities to update countdowns there
                renderActivities('homeActivitiesList', 4);
                renderActivities('activitiesList', Infinity);
            }, 1000);
        }
        
        function completeWithdrawal() {
            clearInterval(withdrawalIntervalId);
            
            if (appState.withdrawal.status !== 'Processing') return;
            
            const amount = appState.withdrawal.details.amount;
            
            // Deduct amount from main balance
            appState.balances.totalUSD -= amount;
            
            // Deduct from holdings (assuming USDT for gas fee/deduction simplicity)
            const usdtHoldings = appState.balances.holdings['USDT'];
            if (usdtHoldings) usdtHoldings.amount = Math.max(0, usdtHoldings.amount - 0.0680); // Deduct the simulated gas fee equivalent

            // Update main activity log
            const lastActivity = appState.activities.find(a => a.type === 'Withdrawal' && a.status === 'Processing');
            if (lastActivity) {
                lastActivity.status = 'Success';
                lastActivity.desc = `Withdrawal of ${formatCurrency(amount)} successful. Fee: 0.034 BNB deducted.`;
                delete lastActivity.endTime;
            }
            
            // Reset withdrawal state
            appState.withdrawal.status = 'None';
            appState.withdrawal.endTime = null;
            appState.withdrawal.details = null;

            saveState();
            
            showToast(`Withdrawal of ${formatCurrency(amount)} successful!`, 'success');
            showPage('home');
        }
        
        function checkWithdrawalSuspension() {
            const banner = document.getElementById('suspensionBanner');
            const timeDisplay = document.getElementById('suspensionTime');
            
            if (appState.withdrawal.status === 'Suspended') {
                const remaining = calculateTimeRemaining(appState.withdrawal.endTime);
                timeDisplay.textContent = `Time Remaining: ${remaining.days}d ${remaining.hours}h ${remaining.minutes}m ${remaining.seconds}s`;
                banner.classList.remove('hidden');
                // Start countdown if not running
                if (!withdrawalIntervalId) startWithdrawalCountdown();
            } else {
                banner.classList.add('hidden');
            }
        }
        
        // =======================================================
        // 7. SUPPORT CHAT (Gemini API Simulation)
        // =======================================================
        
        async function handleSupportChat() {
            const chatInput = document.getElementById('chatInput');
            const chatDiv = document.getElementById('chatContent');
            const message = chatInput.value.trim();

            if (!message) return;
            
            // User Message
            const userEl = document.createElement('div');
            userEl.className = 'text-right text-gray-200';
            userEl.innerHTML = `<span class="inline-block bg-yellow-400 text-gray-900 p-3 rounded-xl rounded-br-none max-w-[80%]">${message}</span>`;
            chatDiv.appendChild(userEl);
            chatInput.value = '';
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // Loading Message
            const loadingEl = document.createElement('div'); 
            loadingEl.className = 'text-left text-gray-200 flex items-center gap-2'; 
            loadingEl.innerHTML = `<span class="animate-pulse bg-gray-700 text-gray-400 p-3 rounded-xl rounded-tl-none max-w-[80%]">Typing...</span>`; 
            chatDiv.appendChild(loadingEl); 
            chatDiv.scrollTop = chatDiv.scrollHeight;

            // Simple Exponential Backoff Retry mechanism
            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const systemPrompt = "Act as a helpful and polite crypto wallet support bot. Keep your responses concise and focus on assisting users with the Auto-Trading Bot, trading, and wallet connection/security.";
                    
                    const payload = {
                        contents: [{ parts: [{ text: message }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };

                    const apiUrl = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    loadingEl.remove();
                    const botReply = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response. Please try again.";
                    
                    const botEl = document.createElement('div');
                    botEl.className = 'text-left text-gray-200';
                    botEl.innerHTML = `<span class="inline-block bg-gray-700 text-gray-200 p-3 rounded-xl rounded-tl-none max-w-[80%]">${botReply}</span>`;
                    chatDiv.appendChild(botEl);
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                    
                    return; // Exit on successful response
                    
                } catch (error) {
                    console.error(`Gemini API call failed (Attempt ${i + 1}):`, error);
                    if (i === MAX_RETRIES - 1) {
                        loadingEl.remove();
                        const finalErrorEl = document.createElement('div');
                        finalErrorEl.className = 'text-left text-red-400 text-sm mt-2';
                        finalErrorEl.textContent = "Support Bot is currently offline. Please check your network or try again later.";
                        chatDiv.appendChild(finalErrorEl);
                        chatDiv.scrollTop = chatDiv.scrollHeight;
                    }
                    await waitFor(Math.pow(2, i) * 1000); // Exponential backoff
                }
            }
        }
        
        // =======================================================
        // 8. GOOGLE AUTH (OTP Simulation)
        // =======================================================

        function setupGoogleAuthUI() {
            document.getElementById('authAccountId').textContent = appState.walletId || 'N/A';
            
            // Generate or load secret key
            if (!appState.auth.secretKey) {
                // Generate a base32 encoded secret (required by Google Auth)
                appState.auth.secretKey = otplib.authenticator.generateSecret();
                saveState();
            }
            
            document.getElementById('authSecretKey').textContent = appState.auth.secretKey;

            // Generate QR Code URL (Standard TOTP format: otpauth://totp/ISSUER:ACCOUNT?secret=SECRET&issuer=ISSUER)
            const issuer = 'AutoTradingBot';
            const account = appState.walletId || 'User';
            const otpUri = otplib.authenticator.keyuri(account, issuer, appState.auth.secretKey);

            // Generate QR code image
            const qrContainer = document.getElementById('authQrCode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: otpUri,
                width: 160,
                height: 160,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('authStatus').textContent = appState.auth.googleAuthLinked ? 'Linked' : 'Not Linked';
        }
        
        async function verifyGoogleAuthCode() {
            const code = document.getElementById('authCodeInput').value.trim();
            const errorMsg = document.getElementById('authCodeError');
            errorMsg.classList.add('hidden');
            
            if (!code || code.length !== 6) {
                errorMsg.textContent = "Please enter the 6-digit code.";
                errorMsg.classList.remove('hidden');
                return;
            }
            
            showLoading("Verifying code (15s)...");
            await waitFor(15000);

            // Verify the token using the secret key
            const isValid = otplib.authenticator.check(code, appState.auth.secretKey);
            
            hideLoading();
            
            if (isValid) {
                appState.auth.googleAuthLinked = true;
                saveState();
                showToast("Google Authenticator linked successfully!", 'success');
                showPage('settingsPage');
            } else {
                errorMsg.textContent = "Invalid code. Please check your authenticator app and try again.";
                errorMsg.classList.remove('hidden');
            }
        }

        // =======================================================
        // 9. HEADER / FOOTER / MENU LOGIC
        // =======================================================

        function toggleMoreMenu() {
            const menu = document.getElementById('more-menu');
            if (menu.classList.contains('hidden')) {
                menu.innerHTML = `
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('walletPage'); closeMoreMenu();">Connected Wallet</button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('settingsPage'); closeMoreMenu();">Settings</button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-700" onclick="showPage('supportPage'); closeMoreMenu();">Support</button>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <button class="w-full text-left px-4 py-2 text-red-400 font-semibold hover:bg-gray-700" onclick="closeAccount(); closeMoreMenu();">Close Account</button>
                    <button class="w-full text-left px-4 py-2 text-red-400 font-semibold hover:bg-gray-700" onclick="disconnectAndReturn(); closeMoreMenu();">Disconnect</button>
                `;
                menu.classList.remove('hidden');
                menu.classList.add('opacity-100');
            } else {
                menu.classList.remove('opacity-100');
                setTimeout(() => menu.classList.add('hidden'), 150);
            }
        }

        function closeMoreMenu() {
            document.getElementById('more-menu').classList.add('hidden');
        }
        
        function toggleLandingMoreMenu() {
            const menu = document.getElementById('landing-more-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('opacity-100');
            } else {
                menu.classList.remove('opacity-100');
                setTimeout(() => menu.classList.add('hidden'), 150);
            }
        }
        
        function closeLandingMoreMenu() {
            document.getElementById('landing-more-menu').classList.add('hidden');
        }
        
        // =======================================================
        // 10. NOTIFICATIONS AND MARKET UPDATES
        // =======================================================
        
        function toggleNotifications(enabled) {
            appState.notifications.enabled = enabled;
            saveState();
            document.getElementById('notificationToggle').checked = enabled;
            document.getElementById('notificationMasterToggle').checked = enabled;
            showToast(`Daily Market Updates are now ${enabled ? 'ON' : 'OFF'}.`, enabled ? 'success' : 'warning');
        }
        
        function loadDailyMarketUpdates() {
            if (!appState.notifications.enabled) return;

            const now = new Date().getTime();
            const hours12 = 12 * 60 * 60 * 1000;
            
            // Only update if 12 hours have passed since last update
            if (now - appState.notifications.lastUpdateTimestamp < hours12) return;

            try {
                // Fetch new data (or simulate a news headline)
                const headline = appState.marketData.topCoins[0]?.name ? 
                    `${appState.marketData.topCoins[0].name} up ${appState.marketData.topCoins[0].price_change_percentage_24h.toFixed(2)}% in the last 24h!` : 
                    "Global crypto market cap is holding steady. New opportunities detected!";
                    
                appState.notifications.messages.unshift({
                    id: Date.now(),
                    text: headline,
                    date: new Date().toISOString()
                });
                appState.notifications.lastUpdateTimestamp = now;
                saveState();
                
                // Show as a pop-up (toast)
                showToast(`Daily Alert: ${headline}`, 'info');

            } catch (error) {
                console.error("Error loading daily updates:", error);
            }
            
            renderNotificationsUI();
        }
        
        function renderNotificationsUI() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            document.getElementById('notificationMasterToggle').checked = appState.notifications.enabled;
            document.getElementById('notificationToggle').checked = appState.notifications.enabled;
            
            if (appState.notifications.messages.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No recent alerts.</p>';
                return;
            }
            
            list.innerHTML = appState.notifications.messages.map(msg => `
                <div class="bg-gray-800 p-3 rounded-lg border-l-4 border-yellow-500">
                    <p class="text-sm font-semibold">${msg.text}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(msg.date).toLocaleDateString()} ${new Date(msg.date).toLocaleTimeString()}</p>
                </div>
            `).join('');
        }
        
        // =======================================================
        // 11. PWA INSTALLATION LOGIC
        // =======================================================
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered', reg))
                    .catch(err => console.error('SW Error', err));
            }
        }

        function generatePwaFiles() {
            // 1. Manifest Generation
            const manifestContent = {
                "name": "Auto-Trading Bot",
                "short_name": "AI Bot",
                "description": "Blockchain Auto-Trading Bot",
                "start_url": "./index.html",
                "display": "standalone",
                "background_color": "#121417",
                "theme_color": "#f0b90b",
                "icons": [
                    { "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’±</text></svg>", "sizes": "512x512", "type": "image/svg+xml" }
                ]
            };
            const blob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(blob);
            document.getElementById('pwa-manifest-link').setAttribute('href', manifestUrl);
            
            // 2. Service Worker Generation and Registration
            const swCode = `
                const CACHE_NAME = 'ai-bot-cache-v1';
                const urlsToCache = [
                    './index.html',
                    '/',
                    'https://cdn.tailwindcss.com',
                    'https://s3.tradingview.com/tv.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
                    'https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js',
                    'https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js',
                    'https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js',
                    'https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js',
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            return cache.addAll(urlsToCache);
                        })
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                    );
                });
            `;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            
            if ('serviceWorker' in navigator) {
                // Register the service worker from its Blob URL
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('SW Registered (Blob)', reg))
                    .catch(err => console.error('SW Error (Blob)', err));
            }
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            document.getElementById('installAppPromptBtn').classList.remove('hidden');
        });
        
        function handleInstallAppDisplay() {
            const container = document.getElementById('installPromptContainer');
            container.innerHTML = `
                <div class="install-prompt">
                    <h3 class="text-xl font-bold mb-2">Install App</h3>
                    <p class="text-gray-400">Install Blockchain Auto-Trading Bot for the best experience!</p>
                    <div class="flex gap-3 mt-4">
                        <button class="btn-yellow px-4 py-2 rounded-lg font-semibold" onclick="handleInstallApp()">
                            Install Now
                        </button>
                        <button class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold" onclick="document.getElementById('installPromptContainer').innerHTML = ''">
                            Maybe Later
                        </button>
                    </div>
                </div>
            `;
        }

        async function handleInstallApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('installPromptContainer').innerHTML = '';
            } else {
                showToast("Install prompt not available. Try adding the app from your browser's menu.", 'info');
            }
        }

        // =======================================================
        // 12. INITIALIZATION
        // =======================================================

        function initializeApp() {
            loadState();
            
            // PWA Setup
            generatePwaFiles();

            // Check if logged in to determine initial page
            let initialPage;
            if (appState.isLoggedIn) {
                initialPage = appState.currentPage === 'landingPage' ? 'home' : appState.currentPage;
            } else {
                initialPage = 'landingPage';
            }
            
            // Load initial market data for landing page or home if needed
            fetchMarketData(initialPage === 'landingPage' ? 'landingPage' : 'home');

            // Show the correct initial page
            showPage(initialPage, true);

            // Start persistent timers for ongoing activities
            if (appState.isLoggedIn) {
                if (appState.trade.active) startTradeCountdown();
                if (appState.withdrawal.status === 'Processing' || appState.withdrawal.status === 'Suspended') startWithdrawalCountdown();
                checkWithdrawalSuspension();
            }

            // Periodic background tasks
            setInterval(() => {
                if (appState.isLoggedIn) {
                    renderHomeUI(); // Updates balance, holdings, activities, suspension banner
                }
            }, 5000); // UI refresh every 5s

            setInterval(() => fetchMarketData(appState.currentPage === 'marketPage' ? 'marketPage' : 'home'), 60000); // Market data refresh every 60s
            setInterval(loadDailyMarketUpdates, 12 * 60 * 60 * 1000); // News check every 12 hours
            
            // Initial call for daily updates (will check timestamp)
            loadDailyMarketUpdates(); 
            
            // Setup listener for trade asset buttons (since they are static HTML)
            setupTradeAssetListeners();
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
